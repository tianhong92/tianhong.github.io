---
title: 线程池
date: 2018-10-04 14:14:25
tags:
---

# 线程池
1. 重用存在的线程， 减少创建， 消亡开销
2. 有效控制最大并发线程数，提高系统资源利用率
3. 提供定时执行， 定期执行， 单线程， 并发数控制功能

注意三个参数： corePoolSize, maximumPoolSize, workQueue

workQueue可以是SynchronousQueue直接切换， 也可以是无界队列（LinkedBlockingQueue）这时maximumPoolSize不起作用。
也可以为有界队列（ArrayBlockingQueue）

如果要减低cpu 内存消耗， 可以设置较小的线程池容量， 较大的队列容量。
如果老阻塞， 可以增大线程池大小。

keepAliveTime:  线程没有任务执行时最多保持多久
unit： KeepAliveTime时间单位
threadFactory: 线程工厂
rejectHandler: 拒绝处理任务时的策略

## 拒绝策略
1. 默认为抛异常
2. 用调用者所在线程执行任务
3. 丢弃队列中最前的任务， 执行当前任务
4. 直接丢弃任务

## 线程池状态
* Running： 能接受新提交的任务， 也能处理阻塞队列中的任务
* Shutdown： 不能接受新的任务， 能处理阻塞队列中的任务
* Stop: 不能再接受新任务， 不能处理队列中的任务， 终端在处理任务的线程
* Tidying： 线程池中工作线程数为0， 可以进入该状态
* Terminated

## ThreadPoolExecutor提供的方法
* execute(): 提交任务， 交给线程池执行
* submit(): 提交任务， 能返回执行结果，execute+future
* shutdown(): 等任务都执行完
* shutdownNow(): 不等任务执行完就关闭

* getTaskCount()
* getCompletedTaskCount()
* getPoolSize() 池中现在的线程数量
* getActiveCount() 当前线程池正在执行任务的线程数

可以在监控类中传入ThreadPoolExecutor实例， 记录下这些数据放入监控图表里面

## Executor框架接口
* Executors.newCachedThreadPool 可创建一个可缓存的线程池， 可以灵活回收空闲线程， 或者新建线程
* newFixedThreadPool 定长线程池， 可控制最大并发数， 超出线程在队列中等待
* newScheduledThreadPool 定长线程池， 支持定时和周期性任务执行
* newSingleThreadExecutor: 单线程线程池， 每个任务按指定顺序（先到先出， 优先级）执行

## 线程池合理配置
CPU密集型任务， 就需要尽量压榨CPU， 参考值为NCPU+1
IO密集型任务， 参考值为两倍CPU

任务很小时候， 线程池调度时间和任务时间差不多， 不适合用线程池




